<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Payments</h2>
    <button mat-raised-button color="primary" (click)="loadPayments()" [disabled]="loading">
      <mat-icon>refresh</mat-icon> Refresh
    </button>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    {{ error }}
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center p-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading payments...</p>
  </div>

  <!-- Payments Table -->
  <div *ngIf="!loading" class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)" class="w-100">
          <!-- Index Column -->
          <ng-container matColumnDef="index">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let payment">{{ getRowNumber(payment) }}</td>
          </ng-container>

          <!-- Payment Date Column -->
          <ng-container matColumnDef="paymentDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
            <td mat-cell *matCellDef="let payment">
              {{ formatDate(payment.paymentDate) }}
            </td>
          </ng-container>

          <!-- Bill Reference Column -->
          <ng-container matColumnDef="billReferenceNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Bill Ref</th>
            <td mat-cell *matCellDef="let payment">
              {{ payment.billReferenceNumber || 'N/A' }}
            </td>
          </ng-container>

          <!-- Third Party Reference Column -->
          <ng-container matColumnDef="thirdPartyReference">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Payment Ref</th>
            <td mat-cell *matCellDef="let payment">
              {{ payment.thirdPartyReference || 'N/A' }}
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="paidAmount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
            <td mat-cell *matCellDef="let payment">
              {{ payment.paidAmount | currency:payment.currency:'symbol-narrow' }}
            </td>
          </ng-container>

          <!-- Payment Channel Column -->
          <ng-container matColumnDef="paymentChannel">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Channel</th>
            <td mat-cell *matCellDef="let payment">
              <span class="badge bg-info text-dark">
                {{ payment.paymentChannel || 'N/A' }}
              </span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let payment">
              <span [class]="getStatusBadgeClass(payment.status)">
                {{ payment.status || 'N/A' }}
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-col">Actions</th>
            <td mat-cell *matCellDef="let payment" class="actions-cell">
              <button mat-icon-button color="primary" [routerLink]="['/payments', payment.uid]" matTooltip="View payment" aria-label="View payment">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="accent" [routerLink]="['/payments', payment.uid, 'edit']" matTooltip="Edit payment" aria-label="Edit payment">
                <mat-icon>edit</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- No Data Message -->
      <div *ngIf="dataSource.data.length === 0 && !loading" class="text-center p-4">
        <p class="text-muted">No payments found</p>
      </div>

      <!-- Pagination -->
      <mat-paginator [length]="totalItems"
                    [pageSize]="pageSize"
                    [pageSizeOptions]="pageSizeOptions"
                    [pageIndex]="pageIndex"
                    (page)="onPageChange($event)"
                    showFirstLastButtons
                    aria-label="Select page of payments">
      </mat-paginator>
    </div>
  </div>
</div>
